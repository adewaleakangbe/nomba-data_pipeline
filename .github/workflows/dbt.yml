name: Run dbt CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  dbt-ci:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: airflow
          POSTGRES_PASSWORD: airflow
          POSTGRES_DB: nomba_warehouse
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dbt and dependencies
      run: |
        pip install dbt-postgres

    - name: Wait for PostgreSQL to be ready
      run: |
        until pg_isready -h localhost -p 5432; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
 
    - name: Create raw tables for testing
      env:
        PGPASSWORD: airflow
      run: |
        psql -h localhost -p 5432 -U airflow -d nomba_warehouse -c"
        CREATE TABLE IF NOT EXISTS raw_users (
            _id TEXT PRIMARY KEY,
            uid TEXT,
            first_name TEXT,
            last_name TEXT,
            occupation TEXT,
            state TEXT,
            loaded_at TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS raw_savings_plan (
            plan_id TEXT PRIMARY KEY,
            product_type TEXT,
            customer_uid TEXT,
            amount NUMERIC,
            frequency TEXT,
            start_date DATE,
            end_date DATE,
            status TEXT,
            created_at TIMESTAMP,
            updated_at TIMESTAMP,
            deleted_at TIMESTAMP,
            loaded_at TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS raw_savings_transaction (
            txn_id TEXT PRIMARY KEY,
            plan_id TEXT,
            amount NUMERIC,
            currency TEXT,
            side TEXT,
            rate NUMERIC,
            txn_timestamp TIMESTAMP,
            updated_at TIMESTAMP,
            deleted_at TIMESTAMP,
            loaded_at TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS sync_state (
            source_name TEXT PRIMARY KEY,
            last_sync_timestamp TIMESTAMP,
            last_sync_id TEXT
        );
        "

    - name: Insert sample data
      env:
        PGPASSWORD: airflow
      run: |
        psql -h localhost -p 5432 -U airflow -d nomba_warehouse -c"
        INSERT INTO raw_users (_id, uid, first_name, last_name, occupation, state, loaded_at) VALUES 
        ('test_001', 'user_001', 'John', 'Doe', 'Engineer', 'Lagos', NOW()),
        ('test_002', 'user_002', 'Jane', 'Smith', 'Teacher', 'Abuja', NOW());
        
        INSERT INTO raw_savings_plan (plan_id, product_type, customer_uid, amount, frequency, start_date, end_date, status, created_at, updated_at, deleted_at, loaded_at) VALUES 
        ('plan_001', 'fixed_deposit', 'user_001', 500000.00, 'monthly', '2024-01-01', '2024-12-31', 'active', NOW(), NOW(), NULL, NOW());
        
        INSERT INTO raw_savings_transaction (txn_id, plan_id, amount, currency, side, rate, txn_timestamp, updated_at, deleted_at, loaded_at) VALUES 
        ('txn_001', 'plan_001', 50000.00, 'NGN', 'buy', 1.0, NOW(), NOW(), NULL, NOW());
        "  

    - name: Debug environment
      run: |
        echo "DBT_HOST: $DBT_HOST"
        echo "DBT_PORT: $DBT_PORT"
        echo "Current directory: $(pwd)"
        ls -la dbt/nomba_dbt/

    - name: Run dbt commands
      env:
        DBT_HOST: localhost
        DBT_PORT: 5432
        DBT_USER: airflow
        DBT_PASS: airflow
        DBT_DBNAME: nomba_warehouse
        DBT_SCHEMA: public
      run: |
        cd dbt/nomba_dbt
        
        # Test connection - MUST use CI target
        dbt debug --target ci
        
        # Run models - MUST use CI target  
        dbt run --target ci
        
        # Run tests - MUST use CI target
        dbt test --target ci